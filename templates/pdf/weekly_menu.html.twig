<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ menu.name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&subset=latin-ext&display=swap" rel="stylesheet">
    <style>
        @page {
            margin: 8mm;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', DejaVu Sans, sans-serif;
            font-size: 18px;
            line-height: 1.3;
            color: #636463;
            padding: 0 5mm;
        }

        .header {
            width: 100%;
            margin-bottom: 4mm;
        }

        .header h1 {
            margin: 0;
            font-size: 42px;
            font-weight: bold;
            text-align: left;
        }

        .header-note {
            font-size: 18px;
            text-align: right;
            vertical-align: bottom;
        }

        .day-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-bottom: 2mm;
        }

        .day-label {
            font-weight: bold;
            font-size: 30px;
            text-align: center;
            vertical-align: middle;
            color: white;
            border: 0.5px solid #636463;
            padding: 4px 2px;
            height: 63mm;
        }

        .meal-cell {
            vertical-align: top;
            border: 0.5px solid #636463;
            border-left-width: 0.5px;
            padding: 0;
            height: 68mm;
        }

        .meal-cell-first {
            border-left-width: 0.5px;
        }

        .meal-cell-last {
            border-right-width: 1px;
        }

        .meal-cell-header {
            font-weight: bold;
            text-align: center;
            font-size: 18px;
            padding: 4px 3px;
            border-bottom: 0.5px solid #636463;
        }

        .meal-cell-content {
            padding: 0;
            font-size: 16px;
            text-align: center;
        }

        .course-block {
            margin: 0;
            padding: 0;
        }

        .course-content {
            padding: 4px;
            text-align: center;
        }

        .course-separator {
            margin-top: 3px;
        }

        .course-separator .variant-header {
            border-top: 0.5px solid #636463;
        }

        .variants-table {
            width: 100%;
            border-collapse: collapse;
        }

        .variants-table-with-border {
            border-bottom: 0.5px solid #636463;
        }

        .variant-header {
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            font-size: 16px;
            padding: 3px 3px;
            border-bottom: 0.5px solid #636463;
            border-left: 0.5px solid #636463;
        }

        .variant-header-first {
            border-left: none;
        }

        .variant-content {
            vertical-align: top;
            text-align: center;
            padding: 4px;
            border-left: 0.5px solid #636463;
        }

        .variant-content-first {
            border-left: none;
        }

        .diet-badge {
            display: inline;
            background: #68ACD2;
            color: white;
            font-size: 13px;
            padding: 2px 4px;
            border-radius: 3px;
            margin-right: 2px;
            font-weight: bold;
        }

        .meal-line {
            margin-bottom: 2px;
        }

        .meal-variant-line {
            margin-bottom: 2px;
        }

        .course-soup {
            border-top: 0.5px solid #636463;
            border-bottom: 0.5px solid #636463;
        }

        .course-soup-first {
            border-top: none;
        }

        .course-soup-last {
            border-bottom: none;
        }

        .footer {
            text-align: center;
            font-size: 16px;
            color: #636463;
            height: 10mm;
        }

        .footer-line {
            margin-bottom: 2px;
        }
    </style>
</head>
<body>
    {% macro renderMeals(variant) %}
        {% for variantMeal in variant.meals %}
            <div class="meal-line">
                {%- if variantMeal.meal.hasDiets -%}
                    {%- for diet in variantMeal.meal.diets -%}
                        {%- for code in diet.dietCodes -%}
                            <span class="diet-badge">{{ code.value }}</span>
                        {%- endfor -%}
                    {%- endfor -%}
                {%- endif -%}
                {{ variantMeal.meal.name }}
            </div>
            {% if variantMeal.meal.hasVariants %}
                {% for mealVariant in variantMeal.meal.variants %}
                    <div class="meal-variant-line">
                        {%- for diet in mealVariant.effectiveDiets -%}
                            {%- for code in diet.dietCodes -%}
                                <span class="diet-badge">{{ code.value }}</span>
                            {%- endfor -%}
                        {%- endfor -%}
                        {{ mealVariant.displayName }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endmacro %}

    {% import _self as macros %}

    {% set mealTypeOrder = ['breakfast', 'lunch', 'snack', 'dinner', 'late_dinner'] %}
    {% set mealTypeLabels = {
        'breakfast': 'Snídaně',
        'lunch': 'Oběd',
        'dinner': 'Večeře',
        'snack': 'Svačina',
        'late_dinner': 'II. Večeře'
    } %}

    {% set dayColors = {
        1: '#68ACD2',
        2: '#94BF6A',
        3: '#EAC157',
        4: '#D68142',
        5: '#AD3533',
        6: '#9F9F9E',
        7: '#636463'
    } %}
    {% set dayLightColors = {
        1: '#d2e6f2',
        2: '#dfecd2',
        3: '#f9eccd',
        4: '#f3d9c6',
        5: '#e6c2c2',
        6: '#e2e2e2',
        7: '#d0d1d0'
    } %}
    {% set dayHeaderColors = {
        1: '#e8f3f9',
        2: '#eff6e8',
        3: '#fcf5e6',
        4: '#f9ece2',
        5: '#f2e0e0',
        6: '#f0f0f0',
        7: '#e7e8e7'
    } %}

    <table class="header">
        <tr>
            <td><h1>Jídelní lístek: {{ menu.name }} &ndash; od {{ menu.validFrom|date('j. n.') }} do {{ menu.validTo|date('j. n. Y') }}</h1></td>
            <td class="header-note">Na požádání lze připravit i vegetariánskou stravu.</td>
        </tr>
    </table>

    {% for day in menu.days %}
        {% set mealTypeMap = {} %}
        {% for mt in day.mealTypes %}
            {% set mealTypeMap = mealTypeMap|merge({ (mt.mealType.value): mt }) %}
        {% endfor %}

        {% set dayBg = dayColors[day.dayOfWeek] ?? '#636463' %}
        {% set dayLightBg = dayLightColors[day.dayOfWeek] ?? '#d0d1d0' %}
        {% set dayHeaderBg = dayHeaderColors[day.dayOfWeek] ?? '#e7e8e7' %}

        <table class="day-table">
            <tr>
                <td class="day-label" style="width: 4%; background-color: {{ dayBg }}">{{ day.dayLabelShort }}</td>
                {% for mealTypeKey in mealTypeOrder %}
                    {% if mealTypeKey == 'lunch' or mealTypeKey == 'dinner' %}
                        <td class="meal-cell{% if loop.first %} meal-cell-first{% endif %}{% if loop.last %} meal-cell-last{% endif %}" style="width: 27%;">
                    {% elseif mealTypeKey == 'snack' %}
                        <td class="meal-cell{% if loop.first %} meal-cell-first{% endif %}{% if loop.last %} meal-cell-last{% endif %}" style="width: 16%;">
                    {% else %}
                        <td class="meal-cell{% if loop.first %} meal-cell-first{% endif %}{% if loop.last %} meal-cell-last{% endif %}" style="width: 13%;">
                    {% endif %}
                        <div class="meal-cell-header" style="background-color: {{ dayHeaderBg }}">{{ mealTypeLabels[mealTypeKey] }}</div>
                        <div class="meal-cell-content">
                            {% if mealTypeMap[mealTypeKey] is defined %}
                                {% set mealTypeData = mealTypeMap[mealTypeKey] %}
                                {% for course in mealTypeData.courses %}
                                    {% set isSoup = course.containsDishType('Polévka') %}
                                    {% set nextCourse = mealTypeData.courses[loop.index] ?? null %}
                                    {% set nextIsVariant = nextCourse and not nextCourse.singleVariantMode and nextCourse.variants|length >= 1 %}
                                    <div class="course-block{% if not loop.first %} course-separator{% endif %}{% if isSoup %} course-soup{% if loop.first %} course-soup-first{% endif %}{% if loop.last or nextIsVariant %} course-soup-last{% endif %}{% endif %}">
                                        {% set variants = course.variants %}
                                        {% if not course.singleVariantMode and variants|length >= 1 %}
                                            <table class="variants-table{% if not loop.last %} variants-table-with-border{% endif %}">
                                                <tr>
                                                    {% for variant in variants %}
                                                        <td class="variant-header{% if loop.first %} variant-header-first{% endif %}" style="width: {{ (100 / variants|length)|round }}%; background-color: {{ dayLightBg }}">{{ loop.index }}.</td>
                                                    {% endfor %}
                                                </tr>
                                                <tr>
                                                    {% for variant in variants %}
                                                        <td class="variant-content{% if loop.first %} variant-content-first{% endif %}">
                                                            {{ macros.renderMeals(variant) }}
                                                        </td>
                                                    {% endfor %}
                                                </tr>
                                            </table>
                                        {% else %}
                                            <div class="course-content">
                                                {% for variant in variants %}
                                                    {{ macros.renderMeals(variant) }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </td>
                {% endfor %}
            </tr>
        </table>
    {% endfor %}

    <div class="footer">
        <div class="footer-line">
            {% if menu.createdBy %}<strong>Sestavila:</strong> {{ menu.createdBy }}{% endif %}
            {% if menu.createdBy and menu.approvedBy %} | {% endif %}
            {% if menu.approvedBy %}<strong>Schválila:</strong> {{ menu.approvedBy }}{% endif %}
            | Změna jídelníčku vyhrazena | Do seznamu alergenů je možno nahlédnout na vyžádání u vedoucí kuchyně
        </div>
    </div>
</body>
</html>
