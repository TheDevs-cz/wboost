<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ menu.name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&subset=latin-ext&display=swap" rel="stylesheet">
    <style>
        @page {
            margin: 8mm;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', DejaVu Sans, sans-serif;
            font-size: 10px;
            line-height: 1.3;
            margin: 0;
            padding: 0;
            color: #636463;
        }

        .header {
            text-align: center;
            margin-bottom: 5px;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .days-wrapper {
            width: 100%;
            height: 520mm;
            border-collapse: collapse;
        }

        .day-row {
            height: 74mm;
        }

        .day-cell {
            padding: 0;
            vertical-align: top;
        }

        .day-table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .day-label {
            font-weight: bold;
            font-size: 22px;
            text-align: center;
            vertical-align: middle;
            color: white;
            border: 1px solid #636463;
            padding: 6px 4px;
        }

        .meal-header {
            font-weight: bold;
            text-align: center;
            font-size: 11px;
            padding: 6px 4px;
            border-top: 1px solid #636463;
            border-bottom: 1px solid #636463;
            border-left: 2px solid #636463;
            border-right: 2px solid #636463;
        }

        .meal-header-first {
            border-left: 1px solid #636463;
        }

        .meal-header-last {
            border-right: 1px solid #636463;
        }

        .meal-content {
            padding: 0;
            vertical-align: top;
            font-size: 9px;
            border-top: 1px solid #636463;
            border-bottom: 1px solid #636463;
            border-left: 2px solid #636463;
            border-right: 2px solid #636463;
        }

        .meal-content-first {
            border-left: 1px solid #636463;
        }

        .meal-content-last {
            border-right: 1px solid #636463;
        }

        .course-block {
            margin: 0;
            padding: 0;
        }

        .course-separator {
            margin-top: 5px;
        }

        .course-separator .variant-header {
            border-top: 1px solid #636463;
        }

        .course-inline {
            padding: 6px;
        }

        .variants-table {
            width: 100%;
            border-collapse: collapse;
        }

        .variants-table-with-border {
            border-bottom: 1px solid #636463;
        }

        .variant-header {
            text-align: center;
            font-weight: bold;
            font-size: 10px;
            padding: 3px 2px;
            border-bottom: 1px solid #636463;
            border-left: 1px solid #636463;
        }

        .variant-header-first {
            border-left: none;
        }

        .variant-content {
            vertical-align: top;
            padding: 5px 4px;
            border-left: 1px solid #636463;
        }

        .variant-content-first {
            border-left: none;
        }

        .diet-badge {
            display: inline-block;
            vertical-align: middle;
            background: #68ACD2;
            color: white;
            font-size: 8px;
            padding: 1px 3px;
            border-radius: 2px;
            margin-right: 2px;
            font-weight: bold;
            line-height: 1;
        }

        .meal-line {
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .meal-line span,
        .meal-line-text {
            vertical-align: middle;
        }

        .meal-variant-line {
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .meal-variant-line span {
            vertical-align: middle;
        }

        .footer {
            margin-top: 5px;
            text-align: center;
            font-size: 9px;
            color: #636463;
        }

        .footer-line {
            margin-bottom: 2px;
        }
    </style>
</head>
<body>
    {% macro renderMeals(variant) %}
        {% for variantMeal in variant.meals %}
            <div class="meal-line">
                {% if variantMeal.meal.hasDiets %}
                    {% for diet in variantMeal.meal.diets %}
                        {% for code in diet.dietCodes %}
                            <span class="diet-badge">{{ code.value }}</span>
                        {% endfor %}
                    {% endfor %}
                {% endif %}
                <span class="meal-line-text">{{ variantMeal.meal.name }}</span>
            </div>
            {% if variantMeal.meal.hasVariants %}
                {% for mealVariant in variantMeal.meal.variants %}
                    <div class="meal-variant-line">
                        {% for diet in mealVariant.effectiveDiets %}
                            {% for code in diet.dietCodes %}
                                <span class="diet-badge">{{ code.value }}</span>
                            {% endfor %}
                        {% endfor %}
                        <span class="meal-line-text">{{ mealVariant.displayName }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endmacro %}

    {% import _self as macros %}

    {% set mealTypeOrder = ['breakfast', 'lunch', 'dinner', 'snack', 'late_dinner'] %}
    {% set mealTypeLabels = {
        'breakfast': 'Snídaně',
        'lunch': 'Oběd',
        'dinner': 'Večeře',
        'snack': 'Svačina',
        'late_dinner': 'II. Večeře'
    } %}

    {% set dayColors = {
        1: '#68ACD2',
        2: '#94BF6A',
        3: '#EAC157',
        4: '#D68142',
        5: '#AD3533',
        6: '#9F9F9E',
        7: '#636463'
    } %}
    {% set dayLightColors = {
        1: '#d2e6f2',
        2: '#dfecd2',
        3: '#f9eccd',
        4: '#f3d9c6',
        5: '#e6c2c2',
        6: '#e2e2e2',
        7: '#d0d1d0'
    } %}

    <div class="header">
        <h1>Jídelní lístek: {{ menu.name }} &ndash; od {{ menu.validFrom|date('j. n.') }} do {{ menu.validTo|date('j. n. Y') }}</h1>
    </div>

    <table class="days-wrapper">
    {% for day in menu.days %}
        {% set mealTypeMap = {} %}
        {% for mt in day.mealTypes %}
            {% set mealTypeMap = mealTypeMap|merge({ (mt.mealType.value): mt }) %}
        {% endfor %}

        {% set dayBg = dayColors[day.dayOfWeek] ?? '#636463' %}
        {% set dayLightBg = dayLightColors[day.dayOfWeek] ?? '#d0d1d0' %}

        <tr class="day-row">
            <td class="day-cell">
                <table class="day-table">
                    <tr>
                        <td class="day-label" rowspan="2" style="width: 4%; background-color: {{ dayBg }}">{{ day.dayLabelShort }}</td>
                        {% for mealTypeKey in mealTypeOrder %}
                            {% if mealTypeKey == 'lunch' or mealTypeKey == 'dinner' %}
                                <th class="meal-header{% if loop.first %} meal-header-first{% endif %}{% if loop.last %} meal-header-last{% endif %}" style="width: 27%">{{ mealTypeLabels[mealTypeKey] }}</th>
                            {% elseif mealTypeKey == 'snack' %}
                                <th class="meal-header{% if loop.first %} meal-header-first{% endif %}{% if loop.last %} meal-header-last{% endif %}" style="width: 16%">{{ mealTypeLabels[mealTypeKey] }}</th>
                            {% else %}
                                <th class="meal-header{% if loop.first %} meal-header-first{% endif %}{% if loop.last %} meal-header-last{% endif %}" style="width: 13%">{{ mealTypeLabels[mealTypeKey] }}</th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    <tr>
                        {% for mealTypeKey in mealTypeOrder %}
                            <td class="meal-content{% if loop.first %} meal-content-first{% endif %}{% if loop.last %} meal-content-last{% endif %}">
                                {% if mealTypeMap[mealTypeKey] is defined %}
                                    {% set mealTypeData = mealTypeMap[mealTypeKey] %}
                                    {% for course in mealTypeData.courses %}
                                        <div class="course-block{% if not loop.first %} course-separator{% endif %}">
                                            {% set variants = course.variants %}
                                            {% if not course.singleVariantMode and variants|length >= 1 %}
                                                <table class="variants-table{% if not loop.last %} variants-table-with-border{% endif %}">
                                                    <tr>
                                                        {% for variant in variants %}
                                                            <td class="variant-header{% if loop.first %} variant-header-first{% endif %}" style="width: {{ (100 / variants|length)|round }}%; background-color: {{ dayLightBg }}">{{ loop.index }}.</td>
                                                        {% endfor %}
                                                    </tr>
                                                    <tr>
                                                        {% for variant in variants %}
                                                            <td class="variant-content{% if loop.first %} variant-content-first{% endif %}">
                                                                {{ macros.renderMeals(variant) }}
                                                            </td>
                                                        {% endfor %}
                                                    </tr>
                                                </table>
                                            {% else %}
                                                <div class="course-inline">
                                                    {% for variant in variants %}
                                                        {{ macros.renderMeals(variant) }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                </table>
            </td>
        </tr>
    {% endfor %}
    </table>

    <div class="footer">
        <div class="footer-line">
            {% if menu.createdBy %}<strong>Sestavila:</strong> {{ menu.createdBy }}{% endif %}
            {% if menu.createdBy and menu.approvedBy %} | {% endif %}
            {% if menu.approvedBy %}<strong>Schválila:</strong> {{ menu.approvedBy }}{% endif %}
        </div>
        <div class="footer-line">
            Změna jídelníčku vyhrazena | Do seznamu alergenů je možno nahlédnout na vyžádání u vedoucí kuchyně
        </div>
    </div>
</body>
</html>
