<div {{ attributes }}>
    {% if lastSaved %}
        <div class="text-success small mb-2"><i class="mdi mdi-check-circle"></i> Uloženo {{ lastSaved }}</div>
    {% endif %}

    {% set weeklyNutrition = menu.nutritionalValues %}
    {% if weeklyNutrition.hasAnyValue %}
        <div class="alert alert-info nutrition-summary-weekly mb-3">
            <div class="d-flex align-items-center gap-2">
                <i class="mdi mdi-nutrition"></i>
                <strong>Týdenní souhrn:</strong>
                <span class="nutrition-values">{{ weeklyNutrition.formatCompact }}</span>
                {% if not weeklyNutrition.isComplete %}
                    <span class="badge bg-warning text-dark" title="Některá jídla nemají vyplněné nutriční hodnoty"><i class="mdi mdi-alert"></i></span>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <div class="row" data-controller="weekly-menu-dragula">
        {% for day in menu.days %}
            <div class="col-12 mb-4">
                <div class="card sha" style="border: 1px solid #727cf5; border-left-width: 4px;">
                    <div class="card-header d-flex justify-content-between align-items-baseline position-relative" style="background-color: rgba(var(--bs-primary-rgb), 0.08);">
                        <div>
                            <h5 class="m-0">
                                {{ day.dayLabel }}
                                {% if day.date %}
                                    <small class="d-block fw-normal" style="font-size: 0.75rem;">({{ day.date|date('d.m.Y') }})</small>
                                {% endif %}
                            </h5>
                            {% set dayNutrition = day.nutritionalValues %}
                            {% if dayNutrition.hasAnyValue %}
                                <div class="nutrition-summary-day">
                                    <span class="nutrition-values-compact">{{ dayNutrition.formatCompact }}</span>
                                </div>
                            {% endif %}
                        </div>
                        <button
                            type="button"
                            class="btn btn-sm btn-danger m-0"
                            data-controller="confirm"
                            data-confirm-message-value="Opravdu smazat celý den včetně všech jídel?"
                            data-action="click->confirm#confirm click->live#action"
                            data-live-action-param="removeDay"
                            data-live-dayid-param="{{ day.id }}">
                            <i class="mdi mdi-delete"></i> Smazat den
                        </button>
                    </div>
                    <div class="card-body">
                        {% for mealType in day.mealTypes %}
                            <div class="card mb-3" style="border-left: 4px solid {{ mealType.mealType.cssColor }};">
                                <div class="card-header d-flex justify-content-between align-items-center py-2" style="background-color: {{ mealType.mealType.cssColor }}20;">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fw-bold">{{ mealType.mealType.label }}</span>
                                        {% set mealTypeNutrition = mealType.nutritionalValues %}
                                        {% if mealTypeNutrition.hasAnyValue %}
                                            <span class="nutrition-badge">{{ mealTypeNutrition.formatEnergyValue }}</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-primary"
                                            data-action="live#action"
                                            data-live-action-param="addCourse"
                                            data-live-mealtypeid-param="{{ mealType.id }}">
                                            <i class="mdi mdi-plus"></i> Chod
                                        </button>
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-danger"
                                            data-controller="confirm"
                                            data-confirm-message-value="Opravdu smazat toto jídlo dne?"
                                            data-action="click->confirm#confirm click->live#action"
                                            data-live-action-param="removeMealType"
                                            data-live-mealtypeid-param="{{ mealType.id }}">
                                            <i class="mdi mdi-delete"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body py-2"
                                     data-weekly-menu-dragula-target="coursesContainer"
                                     data-meal-type-id="{{ mealType.id }}">
                                    {% if mealType.courses|length == 0 %}
                                        <p class="text-muted mb-0 small">Zatím žádné chody. Klikněte na "+ Chod" pro přidání.</p>
                                    {% else %}
                                        {% for course in mealType.courses %}
                                            <div class="border rounded p-2 mb-2 bg-light" data-course-id="{{ course.id }}">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small d-flex align-items-center gap-1">
                                                        {% if mealType.courses|length > 1 %}
                                                            <i class="mdi mdi-drag course-drag-handle" style="cursor: grab;"></i>
                                                        {% endif %}
                                                        Chod {{ loop.index }}
                                                    </span>
                                                    <div>
                                                        <button
                                                            type="button"
                                                            class="btn btn-sm btn-secondary"
                                                            data-action="live#action"
                                                            data-live-action-param="addVariant"
                                                            data-live-courseid-param="{{ course.id }}"
                                                            data-live-name-param="">
                                                            <i class="mdi mdi-plus"></i> Varianta
                                                        </button>
                                                        <button
                                                            type="button"
                                                            class="btn btn-sm btn-danger"
                                                            data-controller="confirm"
                                                            data-confirm-message-value="Opravdu smazat tento chod?"
                                                            data-action="click->confirm#confirm click->live#action"
                                                            data-live-action-param="removeCourse"
                                                            data-live-courseid-param="{{ course.id }}">
                                                            <i class="mdi mdi-delete"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <div data-weekly-menu-dragula-target="variantsContainer"
                                                     data-course-id="{{ course.id }}">
                                                {% if course.variants|length == 0 %}
                                                    <p class="text-muted mb-0 small">Zatím žádné varianty. Klikněte na "+ Varianta" pro přidání.</p>
                                                {% else %}
                                                    {% for variant in course.variants %}
                                                        <div class="border rounded p-2 mb-2 bg-white" data-variant-id="{{ variant.id }}">
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    {% if course.variants|length > 1 %}
                                                                        <i class="mdi mdi-drag variant-drag-handle" style="cursor: grab;"></i>
                                                                    {% endif %}
                                                                    <input
                                                                        type="text"
                                                                        class="form-control form-control-sm"
                                                                        style="width: 150px;"
                                                                        placeholder="Název varianty..."
                                                                        value="{{ variant.name }}"
                                                                        data-variant-id="{{ variant.id }}"
                                                                        data-action="change->variant-name#save"
                                                                        data-controller="variant-name">
                                                                    {% if not variant.name %}
                                                                        <span class="text-muted" style="font-size: 0.7rem;">Jídla mezi kterými si zákazník vybírá. (Doporučeno např. A, B, C nebo 1, 2, 3)</span>
                                                                    {% endif %}
                                                                </div>
                                                                <div>
                                                                    <button
                                                                        type="button"
                                                                        class="btn btn-sm btn-success"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#mealSelectorModal"
                                                                        data-variant-id="{{ variant.id }}">
                                                                        <i class="mdi mdi-plus"></i> Jídlo
                                                                    </button>
                                                                    <button
                                                                        type="button"
                                                                        class="btn btn-sm btn-danger"
                                                                        data-controller="confirm"
                                                                        data-confirm-message-value="Opravdu smazat tuto variantu?"
                                                                        data-action="click->confirm#confirm click->live#action"
                                                                        data-live-action-param="removeVariant"
                                                                        data-live-variantid-param="{{ variant.id }}">
                                                                        <i class="mdi mdi-delete"></i>
                                                                    </button>
                                                                </div>
                                                            </div>

                                                            {% if variant.meals|length > 0 %}
                                                                <div class="meal-selector-grid"
                                                                     data-weekly-menu-dragula-target="mealsContainer"
                                                                     data-variant-id="{{ variant.id }}">
                                                                    {% for variantMeal in variant.meals %}
                                                                        <div class="meal-selector-item planner-meal-card{% if variant.meals|length > 1 %} draggable{% endif %}"
                                                                             style="border-left: 3px solid {{ variantMeal.meal.mealType.cssColor }};{% if variant.meals|length > 1 %} cursor: grab;{% endif %}"
                                                                             data-variant-meal-id="{{ variantMeal.id }}">
                                                                            <div class="meal-selector-header">
                                                                                <span class="meal-selector-name">{{ variantMeal.meal.internalName }}</span>
                                                                                <span class="meal-selector-type" style="background-color: {{ variantMeal.meal.mealType.cssColor }};">{{ variantMeal.meal.mealType.label|slice(0,2)|upper }}</span>
                                                                                <button
                                                                                    type="button"
                                                                                    class="btn-close flex-shrink-0"
                                                                                    style="font-size: 0.5rem;"
                                                                                    data-action="live#action"
                                                                                    data-live-action-param="removeMeal"
                                                                                    data-live-variantmealid-param="{{ variantMeal.id }}">
                                                                                </button>
                                                                            </div>
                                                                            <div class="meal-selector-meta">
                                                                                {{ variantMeal.meal.dishType.name }}{% if variantMeal.meal.diet %} · <span class="meal-selector-diet">{{ variantMeal.meal.dietCodesLabel }}</span>{% endif %}
                                                                            </div>
                                                                            {% set mealNutrition = variantMeal.meal.nutritionalValues %}
                                                                            {% if mealNutrition.hasAnyValue %}
                                                                                <div class="meal-selector-nutrition">{{ mealNutrition.formatCompact }}</div>
                                                                            {% endif %}
                                                                            {% if variantMeal.meal.hasVariants %}
                                                                                <div class="meal-selector-variants">
                                                                                    {% for mealVariant in variantMeal.meal.variants %}
                                                                                        <span class="meal-selector-variant">{{ mealVariant.displayName }}{% if mealVariant.dietCodesLabel %} ({{ mealVariant.dietCodesLabel }}){% endif %}</span>
                                                                                    {% endfor %}
                                                                                </div>
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                                {% set variantNutrition = variant.nutritionalValues %}
                                                                {% if variantNutrition.hasAnyValue and variant.meals|length > 1 %}
                                                                    <div class="nutrition-summary-variant">
                                                                        <small class="text-muted">Celkem varianta:</small> {{ variantNutrition.formatCompact }}
                                                                    </div>
                                                                {% endif %}
                                                            {% else %}
                                                                <p class="text-muted mb-0 small">Zatím žádná jídla. Klikněte na "+ Jídlo" pro přidání.</p>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">Zatím žádné typy jídel pro tento den.</p>
                        {% endfor %}

                        {% set availableMealTypesForDay = this.availableMealTypesForDay(day) %}
                        {% if availableMealTypesForDay|length > 0 %}
                            <div class="dropdown">
                                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="mdi mdi-plus"></i> Přidat typ jídla
                                </button>
                                <ul class="dropdown-menu">
                                    {% for mealTypeOption in availableMealTypesForDay %}
                                        <li>
                                            <button
                                                type="button"
                                                class="dropdown-item d-flex align-items-center"
                                                data-action="live#action"
                                                data-live-action-param="addMealType"
                                                data-live-dayid-param="{{ day.id }}"
                                                data-live-mealtype-param="{{ mealTypeOption.value }}">
                                                <span class="meal-type-dot me-2" style="background-color: {{ mealTypeOption.cssColor }}; box-shadow: inset 0 0 0 2px rgba(0,0,0,0.15);"></span>
                                                {{ mealTypeOption.label }}
                                            </button>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% else %}
                            <p class="text-muted small mb-0"><i class="mdi mdi-check-circle text-success"></i> Všechny typy jídel jsou přidány</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Meal Selector Modal -->
    <div class="modal fade" id="mealSelectorModal" tabindex="-1" aria-labelledby="mealSelectorModalLabel" aria-hidden="true"
         data-controller="meal-selector">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mealSelectorModalLabel">Vybrat jídlo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" data-meal-selector-target="variantId" value="">

                    {% set allMeals = this.meals %}
                    {% set allDiets = this.diets %}
                    {% set allMealTypes = this.availableMealTypes %}
                    {% if allMeals|length == 0 %}
                        <div class="alert alert-info">
                            Zatím nebyla vytvořena žádná jídla. <a href="{{ path('meals', {'projectId': menu.project.id}) }}">Vytvořte je zde.</a>
                        </div>
                    {% else %}
                        <div class="row mb-3">
                            <div class="col-md-6 mb-2 mb-md-0">
                                <input type="text"
                                       class="form-control"
                                       placeholder="Hledat jídlo..."
                                       data-meal-selector-target="searchInput"
                                       data-action="input->meal-selector#filter">
                            </div>
                            <div class="col-md-3 mb-2 mb-md-0">
                                <select class="form-select"
                                        data-meal-selector-target="mealTypeFilter"
                                        data-action="change->meal-selector#filter">
                                    <option value="">Všechny typy jídel</option>
                                    {% for mealType in allMealTypes %}
                                        <option value="{{ mealType.value }}">{{ mealType.label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select"
                                        data-meal-selector-target="dietFilter"
                                        data-action="change->meal-selector#filter">
                                    <option value="">Všechny diety</option>
                                    {% for diet in allDiets %}
                                        <option value="{{ diet.id }}">{{ diet.name }} ({{ diet.codesLabel }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="meal-selector-grid" data-meal-selector-target="mealsContainer">
                            {% for meal in allMeals %}
                                <div class="meal-selector-item"
                                     data-meal-selector-target="mealCard"
                                     data-meal-type="{{ meal.mealType.value }}"
                                     data-diet-id="{{ meal.diet ? meal.diet.id : '' }}"
                                     data-search-text="{{ meal.internalName|lower }} {{ meal.name|lower }} {{ meal.dishType.name|lower }} {{ meal.dietCodesLabel|lower }}"
                                     data-meal-id="{{ meal.id }}"
                                     data-action="click->meal-selector#selectMeal"
                                     style="border-left: 3px solid {{ meal.mealType.cssColor }};">
                                    <div class="meal-selector-header">
                                        <span class="meal-selector-name">{{ meal.internalName }}</span>
                                        <span class="meal-selector-type" style="background-color: {{ meal.mealType.cssColor }};">{{ meal.mealType.label|slice(0,2)|upper }}</span>
                                    </div>
                                    <div class="meal-selector-meta">
                                        {{ meal.dishType.name }}{% if meal.diet %} · <span class="meal-selector-diet">{{ meal.dietCodesLabel }}</span>{% endif %}
                                    </div>
                                    {% set modalMealNutrition = meal.nutritionalValues %}
                                    {% if modalMealNutrition.hasAnyValue %}
                                        <div class="meal-selector-nutrition">{{ modalMealNutrition.formatCompact }}</div>
                                    {% endif %}
                                    {% if meal.hasVariants %}
                                        <div class="meal-selector-variants">
                                            {% for variant in meal.variants %}
                                                <span class="meal-selector-variant">{{ variant.displayName }}{% if variant.dietCodesLabel %} ({{ variant.dietCodesLabel }}){% endif %}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <div class="alert alert-warning d-none" data-meal-selector-target="noResults">
                            Žádná jídla neodpovídají zadaným filtrům.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
