<div {{ attributes.defaults(stimulus_controller('weekly-menu-sync')) }}>
    {% set menuDay = this.activeMenuDay %}

    {# Header with name and date range #}
    <div class="card mb-3">
        <div class="card-body">
            {% if editingHeader %}
                {# Edit mode #}
                <div class="row align-items-end mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Název jídelníčku</label>
                        <input type="text"
                               class="form-control"
                               data-model="norender|headerName">
                    </div>
                    <div class="col-md-3" data-controller="flatpickr-range">
                        <label class="form-label">Platnost</label>
                        <input type="text"
                               class="form-control"
                               placeholder="Vyberte období"
                               data-input>
                        <input type="hidden"
                               data-flatpickr-range-target="from"
                               data-model="norender|headerValidFrom">
                        <input type="hidden"
                               data-flatpickr-range-target="to"
                               data-model="norender|headerValidTo">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Vytvořil</label>
                        <input type="text"
                               class="form-control"
                               data-model="norender|headerCreatedBy">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Schválil</label>
                        <input type="text"
                               class="form-control"
                               data-model="norender|headerApprovedBy">
                    </div>
                </div>
                <div class="d-flex justify-content-end align-items-center gap-3">
                    <button type="button"
                            class="btn btn-outline-secondary btn-sm"
                            data-action="live#action"
                            data-live-action-param="toggleHeaderEdit">
                        Zrušit
                    </button>
                    <button type="button"
                            class="btn btn-primary btn-sm"
                            data-action="live#action"
                            data-live-action-param="saveHeader">
                        <i class="mdi mdi-content-save"></i> Uložit
                    </button>
                </div>
            {% else %}
                {# Read mode #}
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h4 class="mt-0 mb-2">{{ menu.name }}</h4>
                        <p class="text-muted mb-1">
                            <i class="mdi mdi-calendar-range"></i>
                            {{ menu.validFrom|date('j.n.Y') }} – {{ menu.validTo|date('j.n.Y') }}
                        </p>
                        {% if menu.createdBy or menu.approvedBy %}
                            <p class="text-muted mb-0 small">
                                {% if menu.createdBy %}Vytvořil: {{ menu.createdBy }}{% endif %}
                                {% if menu.createdBy and menu.approvedBy %} · {% endif %}
                                {% if menu.approvedBy %}Schválil: {{ menu.approvedBy }}{% endif %}
                            </p>
                        {% endif %}
                    </div>
                    <button type="button"
                            class="btn btn-outline-secondary btn-sm"
                            data-action="live#action"
                            data-live-action-param="toggleHeaderEdit">
                        <i class="mdi mdi-pencil"></i> Upravit
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    {# Day tabs #}
    <ul class="nav nav-tabs mb-3">
        {% for dayNumber in 1..7 %}
            {% set dayNames = {1: 'Pondělí', 2: 'Úterý', 3: 'Středa', 4: 'Čtvrtek', 5: 'Pátek', 6: 'Sobota', 7: 'Neděle'} %}
            <li class="nav-item">
                <button type="button"
                        class="nav-link {{ activeDay == dayNumber ? 'active' : '' }}"
                        data-action="live#action"
                        data-live-action-param="switchDay"
                        data-live-day-param="{{ dayNumber }}">
                    {{ dayNames[dayNumber] }}
                </button>
            </li>
        {% endfor %}
    </ul>

    {# Meals for active day #}
    {% if menuDay %}
        <div id="day-{{ activeDay }}-meals" data-live-id="day-{{ activeDay }}-meals">
        {% for meal in menuDay.meals %}
            <div class="card mb-3" style="border-left: 4px solid {{ meal.type.cssColor }};" data-live-id="meal-{{ meal.id }}">
                <div class="card-header" style="background-color: {{ meal.type.cssColor }}20;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ meal.type.label }}</h5>
                        {% if meal.variants|length < 3 %}
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary"
                                    data-action="live#action"
                                    data-live-action-param="addVariant"
                                    data-live-meal-id-param="{{ meal.id }}">
                                <i class="mdi mdi-plus"></i> Přidat variantu
                            </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="variants-container"
                         data-controller="weekly-menu-dragula"
                         data-weekly-menu-dragula-meal-id-value="{{ meal.id }}"
                         data-weekly-menu-dragula-type-value="variants"
                         data-weekly-menu-dragula-sort-url-value="{{ path('sort_weekly_menu_variants', {'menuId': menu.id, 'mealId': meal.id}) }}">
                        {% for variant in meal.variants %}
                            <div class="variant-card border rounded p-3 mb-3" data-id="{{ variant.id }}" data-live-id="variant-{{ variant.id }}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center flex-grow-1">
                                        <span class="drag-handle me-2 {{ meal.variants|length > 1 ? '' : 'invisible' }}" style="cursor: move;">
                                            <i class="mdi mdi-drag-vertical text-muted"></i>
                                        </span>
                                        <div class="flex-grow-1"
                                             data-controller="weekly-menu-autosave"
                                             data-weekly-menu-autosave-save-action-value="updateVariantName"
                                             data-live-id="variant-form-{{ variant.id }}">
                                            <input type="text"
                                                   name="name"
                                                   class="form-control form-control-sm"
                                                   placeholder="Název varianty (volitelné)"
                                                   value="{{ variant.name }}"
                                                   data-weekly-menu-autosave-target="input"
                                                   data-action="input->weekly-menu-autosave#scheduleAutosave"
                                                   data-live-id="variant-name-{{ variant.id }}"
                                                   data-server-value="{{ variant.name }}"
                                                   data-weekly-menu-sync-target="input">
                                            <input type="hidden" name="variantId" value="{{ variant.id }}" data-weekly-menu-autosave-target="input">
                                        </div>
                                    </div>
                                    {% if meal.variants|length > 1 %}
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger ms-2"
                                                data-action="live#action"
                                                data-live-action-param="removeVariant"
                                                data-live-variant-id-param="{{ variant.id }}"
                                                title="Odstranit variantu">
                                            <i class="mdi mdi-close"></i>
                                        </button>
                                    {% endif %}
                                </div>

                                {# Diet versions within variant #}
                                <div class="diet-versions-container ms-4"
                                     data-controller="weekly-menu-dragula"
                                     data-weekly-menu-dragula-variant-id-value="{{ variant.id }}"
                                     data-weekly-menu-dragula-type-value="dietVersions"
                                     data-weekly-menu-dragula-sort-url-value="{{ path('sort_weekly_menu_diet_versions', {'menuId': menu.id, 'variantId': variant.id}) }}">
                                    {% for dietVersion in variant.dietVersions %}
                                        <div class="diet-version-row d-flex align-items-center mb-2 p-2 bg-light rounded" data-id="{{ dietVersion.id }}" data-live-id="diet-version-{{ dietVersion.id }}">
                                            <span class="drag-handle me-2 {{ variant.dietVersions|length > 1 ? '' : 'invisible' }}" style="cursor: move;">
                                                <i class="mdi mdi-drag-horizontal text-muted"></i>
                                            </span>
                                            <div class="flex-grow-1"
                                                 data-controller="weekly-menu-autosave"
                                                 data-weekly-menu-autosave-save-action-value="updateDietVersion"
                                                 data-live-id="diet-version-form-{{ dietVersion.id }}">
                                                <div class="row g-2">
                                                    <div class="col-md-2">
                                                        <input type="text"
                                                               name="dietCodes"
                                                               class="form-control form-control-sm"
                                                               placeholder="Diety (9,3)"
                                                               value="{{ dietVersion.dietCodes }}"
                                                               data-weekly-menu-autosave-target="input"
                                                               data-action="input->weekly-menu-autosave#scheduleAutosave"
                                                               data-live-id="diet-codes-{{ dietVersion.id }}"
                                                               data-server-value="{{ dietVersion.dietCodes }}"
                                                               data-weekly-menu-sync-target="input">
                                                    </div>
                                                    <div class="col-md-10">
                                                        <input type="text"
                                                               name="items"
                                                               class="form-control form-control-sm"
                                                               placeholder="Položky menu (oddělené čárkou)"
                                                               value="{{ dietVersion.items }}"
                                                               data-weekly-menu-autosave-target="input"
                                                               data-action="input->weekly-menu-autosave#scheduleAutosave"
                                                               data-live-id="diet-items-{{ dietVersion.id }}"
                                                               data-server-value="{{ dietVersion.items }}"
                                                               data-weekly-menu-sync-target="input">
                                                    </div>
                                                </div>
                                                <input type="hidden" name="dietVersionId" value="{{ dietVersion.id }}" data-weekly-menu-autosave-target="input">
                                            </div>
                                            {% if variant.dietVersions|length > 1 %}
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger ms-2"
                                                        data-action="live#action"
                                                        data-live-action-param="removeDietVersion"
                                                        data-live-diet-version-id-param="{{ dietVersion.id }}"
                                                        title="Odstranit dietní verzi">
                                                    <i class="mdi mdi-close"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>

                                {% if variant.dietVersions|length < 2 %}
                                    <div class="ms-4 mt-2">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary"
                                                data-action="live#action"
                                                data-live-action-param="addDietVersion"
                                                data-live-variant-id-param="{{ variant.id }}">
                                            <i class="mdi mdi-plus"></i> Přidat dietní verzi
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>
    {% endif %}

    {# Footer with save status and back button #}
    <div class="card mt-3">
        <div class="card-body d-flex justify-content-between align-items-center">
            <a href="{{ path('weekly_menus', {'projectId': menu.project.id}) }}" class="btn btn-outline-secondary">
                <i class="mdi mdi-arrow-left"></i> Zpět na seznam
            </a>
            <div class="d-flex align-items-center gap-3">
                {% if lastSaved %}
                    <small class="text-muted">
                        <i class="mdi mdi-check-circle text-success"></i>
                        Uloženo {{ lastSaved }}
                    </small>
                {% else %}
                    <small class="text-muted">
                        <i class="mdi mdi-information-outline"></i>
                        Změny se ukládají automaticky
                    </small>
                {% endif %}
                <button type="button"
                        class="btn btn-primary"
                        data-action="live#action"
                        data-live-action-param="saveHeader">
                    <i class="mdi mdi-content-save"></i> Uložit změny
                </button>
            </div>
        </div>
    </div>

</div>
