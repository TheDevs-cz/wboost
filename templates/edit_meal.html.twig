{% extends 'base.html.twig' %}

{% set active_menu_item = 'weekly_menus' %}
{% set active_submenu_item = 'meals' %}

{% block title %}Upravit jídlo{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb m-0 pt-0">
        <li class="breadcrumb-item"><i class="uil-home-alt"></i> <a href="{{ path('homepage') }}">Projekty</a></li>
        <li class="breadcrumb-item"><a href="{{ path('project_dashboard', {'id': project.id}) }}">{{ project.name }}</a></li>
        <li class="breadcrumb-item"><a href="{{ path('weekly_menus', {'projectId': project.id}) }}">Jídelníčky</a></li>
        <li class="breadcrumb-item"><a href="{{ path('meals', {'projectId': project.id}) }}">Seznam jídel</a></li>
        <li class="breadcrumb-item active">{{ block('title') }}</li>
    </ol>
{% endblock %}

{% macro variant_fields(variant, meals, diets) %}
    {% set mealTypes = ['breakfast', 'lunch', 'snack', 'dinner', 'late_dinner'] %}
    {% set mealTypeLabels = {'breakfast': 'Snídaně', 'lunch': 'Oběd', 'snack': 'Svačina', 'dinner': 'Večeře', 'late_dinner': 'Druhá večeře'} %}

    {{ form_widget(variant.id) }}
    <div data-controller="reference-meal-selector">
        {{ form_widget(variant.referenceMealId, {'attr': {'data-reference-meal-selector-target': 'hiddenInput'}}) }}

        <div class="row">
            <div class="col-md-6">
                {{ form_row(variant.mode) }}
            </div>
            <div class="col-md-6" data-meal-variant-mode-target="referenceWrapper">
                {# Selected meal preview area #}
                <div class="reference-meal-preview mb-3">
                    <div class="reference-meal-selected" data-reference-meal-selector-target="selectedPreview">
                        {# Will be populated by JS when a meal is selected #}
                    </div>
                    <div class="reference-meal-empty text-muted p-3 border rounded bg-light" data-reference-meal-selector-target="emptyPreview">
                        <i class="mdi mdi-information-outline"></i> Vyberte jídlo ze seznamu níže
                    </div>
                </div>
                {# Clear selection button #}
                <button type="button" class="btn btn-sm btn-outline-secondary mb-2 d-none" data-action="reference-meal-selector#clearSelection" data-reference-meal-selector-target="clearButton">
                    <i class="mdi mdi-close"></i> Zrušit výběr
                </button>
            </div>
        </div>

        <div data-meal-variant-mode-target="referenceWrapper">
            {% if meals|length > 0 %}
                {# Filters #}
                <div class="row mb-2 g-2">
                    <div class="col-md-6">
                        <input type="text"
                               class="form-control form-control-sm"
                               placeholder="Hledat jídlo..."
                               data-reference-meal-selector-target="searchInput"
                               data-action="input->reference-meal-selector#filter">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm"
                                data-reference-meal-selector-target="mealTypeFilter"
                                data-action="change->reference-meal-selector#filter">
                            <option value="">Všechny typy</option>
                            {% for typeValue, typeLabel in mealTypeLabels %}
                                <option value="{{ typeValue }}">{{ typeLabel }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm"
                                data-reference-meal-selector-target="dietFilter"
                                data-action="change->reference-meal-selector#filter">
                            <option value="">Všechny diety</option>
                            {% for diet in diets %}
                                <option value="{{ diet.id }}">{{ diet.name }} ({{ diet.codesLabel }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                {# Scrollable meal grid #}
                <div class="reference-meal-grid-container">
                    <div class="meal-selector-grid">
                        {% for meal in meals %}
                            <div class="meal-selector-item"
                                 data-reference-meal-selector-target="mealCard"
                                 data-meal-type="{{ meal.mealType.value }}"
                                 data-diet-id="{{ meal.diet ? meal.diet.id : '' }}"
                                 data-search-text="{{ meal.internalName|lower }} {{ meal.name|lower }} {{ meal.dietCodesLabel|lower }}"
                                 data-meal-id="{{ meal.id }}"
                                 data-action="click->reference-meal-selector#selectMeal"
                                 style="border-left: 3px solid {{ meal.mealType.cssColor }};">
                                {% include 'partials/_meal_card.html.twig' with {meal: meal} only %}
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="alert alert-warning d-none mt-2" data-reference-meal-selector-target="noResults">
                    Žádná jídla neodpovídají zadaným filtrům.
                </div>
            {% else %}
                <div class="alert alert-info">
                    Zatím nebyla vytvořena žádná jídla k odkázání.
                </div>
            {% endif %}
        </div>
    </div>

    <div data-meal-variant-mode-target="manualWrapper">
        <div class="row">
            <div class="col-md-6">
                {{ form_row(variant.name) }}
            </div>
            <div class="col-md-6">
                {{ form_row(variant.dietId) }}
            </div>
        </div>

        <label class="form-label mt-2">Nutriční hodnoty</label>
        <div class="row">
            <div class="col-md-3">
                {{ form_row(variant.energyValue) }}
            </div>
            <div class="col-md-3">
                {{ form_row(variant.fats) }}
            </div>
            <div class="col-md-3">
                {{ form_row(variant.carbohydrates) }}
            </div>
            <div class="col-md-3">
                {{ form_row(variant.proteins) }}
            </div>
        </div>
    </div>
{% endmacro %}

{% block content %}
    <div class="card">
        <div class="card-body">
            {{ form_start(form) }}

            <div class="row">
                <div class="col-md-6">
                    {{ form_row(form.internalName) }}
                </div>
                <div class="col-md-6">
                    {{ form_row(form.name) }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    {{ form_row(form.mealType) }}
                </div>
                <div class="col-md-4">
                    {{ form_row(form.dishTypeId) }}
                </div>
                <div class="col-md-4">
                    {{ form_row(form.dietId) }}
                </div>
            </div>

            <div class="p-3 border rounded bg-light mb-3">
                <h5 class="mb-1">Nutriční hodnoty (volitelné)</h5>
                <p class="text-muted small mb-3">Zadejte nutriční hodnoty pro toto jídlo.</p>

                <div class="row mb-0">
                    <div class="col-md-3">
                        {{ form_row(form.energyValue) }}
                    </div>
                    <div class="col-md-3">
                        {{ form_row(form.fats) }}
                    </div>
                    <div class="col-md-3">
                        {{ form_row(form.carbohydrates) }}
                    </div>
                    <div class="col-md-3">
                        {{ form_row(form.proteins) }}
                    </div>
                </div>
            </div>

            <h5>Dietní varianty (volitelné, max. 4)</h5>
            <p class="text-muted small">Můžete přidat různé dietní varianty tohoto jídla, např. bezlepkovou nebo vegetariánskou verzi. Variantu lze zadat ručně nebo odkázat na jiné existující jídlo.</p>

            <div data-controller="collection"
                 data-collection-prototype-value="{{ _self.variant_fields(form.variants.vars.prototype, meals, diets)|e('html_attr') }}"
                 data-collection-index-value="{{ form.variants|length }}"
                 data-collection-max-items-value="4">

                <div data-collection-target="container">
                    {% for variant in form.variants %}
                        <div class="variant-item mb-3 p-3 border rounded bg-light" data-controller="meal-variant-mode">
                            {{ _self.variant_fields(variant, meals, diets) }}
                            <button type="button" class="btn btn-sm btn-danger mt-2" data-action="collection#removeExisting">
                                <i class="mdi mdi-delete"></i> Odebrat variantu
                            </button>
                        </div>
                    {% endfor %}
                </div>

                <button type="button"
                        class="btn btn-outline-secondary btn-sm mb-3"
                        data-collection-target="addButton"
                        data-action="collection#add">
                    <i class="mdi mdi-plus"></i> Přidat dietní variantu
                </button>
            </div>
            {% do form.variants.setRendered() %}

            <hr>
            <button class="btn btn-primary" type="submit">Uložit</button>
            <a href="{{ path('meals', {'projectId': project.id}) }}" class="btn btn-outline-secondary">Zrušit</a>

            {{ form_end(form) }}
        </div>
    </div>
{% endblock %}
